<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title id="pageTitle">Chi ti·∫øt s·∫£n ph·∫©m</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <a href="index.html" style="color:var(--muted);display:inline-block;margin-bottom:8px;">‚óÄ Quay l·∫°i trang ch·ªß</a>
    <div id="productDetail">
      <p style="text-align:center;margin-top:40px;">ƒêang t·∫£i chi ti·∫øt s·∫£n ph·∫©m...</p>
    </div>
  </div>

<script>
function getUserFullname(username) {
  const users = JSON.parse(localStorage.getItem("users") || "[]");
  const user = users.find(u => u.username === username);
  return user ? user.fullname : (username || "Ng∆∞·ªùi d√πng ·∫©n danh");
}
function formatPrice(price) {
  if (price === undefined || price === null || price === "") return "(Ch∆∞a c√≥ gi√°)";
  return Number(price).toLocaleString('vi-VN') + " ƒë";
}
function getIdFromUrl(){ return new URLSearchParams(window.location.search).get('id') || ""; }

function renderProduct(product){
  const currentUser = JSON.parse(localStorage.getItem("currentUser") || "{}");
  const isCreator = currentUser.username === product.creator;
  const creatorName = getUserFullname(product.creator);

  const editButton = isCreator ?
    `<button class="btn" onclick="location.href='add-do.html?id=${product.id}'; event.stopPropagation();">‚úèÔ∏è Ch·ªânh s·ª≠a</button>
     <button class="btn danger" onclick="confirmDelete('${product.id}'); event.stopPropagation();">üóëÔ∏è X√≥a</button>` : '';

  document.getElementById('pageTitle').textContent = product.name;

  document.getElementById('productDetail').innerHTML = `
    <div class="detail-card">
      <div class="detail-image">
        <img src="${product.image || 'avatar.jpg'}" alt="${product.name}">
      </div>
      <div class="detail-content">
        <h1>${product.name}</h1>
        <p class="muted">üè∑Ô∏è Danh m·ª•c: <b>${product.category || '-'}</b></p>
        <p class="muted italic">ƒêƒÉng b·ªüi: <b>${creatorName}</b></p>

        <div class="detail-info">
          <p class="price" style="font-size:1.25rem">Gi√°: ${formatPrice(product.price)}</p>
        </div>

        <div class="detail-description">
          <h2>M√¥ t·∫£ s·∫£n ph·∫©m</h2>
          <p>${product.desc || '<i>(Kh√¥ng c√≥ m√¥ t·∫£ chi ti·∫øt)</i>'}</p>
        </div>

        <div style="margin-top:18px">
          ${editButton}
        </div>
      </div>
    </div>
  `;
}

function confirmDelete(id){
  if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a?")) return;
  let products = JSON.parse(localStorage.getItem("products") || "[]");
  products = products.filter(p => String(p.id) !== String(id));
  localStorage.setItem("products", JSON.stringify(products));
  alert("ƒê√£ x√≥a s·∫£n ph·∫©m.");
  location.href = "index.html";
}

function loadProductDetail() {
  const productId = getIdFromUrl();
  if (!productId) {
    document.getElementById('productDetail').innerHTML = '<h1 style="text-align:center;">ID s·∫£n ph·∫©m kh√¥ng h·ª£p l·ªá.</h1>';
    return;
  }

  const products = JSON.parse(localStorage.getItem("products") || "[]");
  const product = products.find(p => String(p.id) === String(productId));

  if (!product) {
    document.getElementById('productDetail').innerHTML = '<h1 style="text-align:center;margin-top:50px;">S·∫£n ph·∫©m kh√¥ng t·ªìn t·∫°i.</h1>';
    return;
  }

  renderProduct(product);
}

loadProductDetail();
</script>
</body>
</html>
